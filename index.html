<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¬¬äºŒç´šãƒ‡ã‚¸ã‚¿ãƒ«é€šä¿¡ã‚¯ã‚¤ã‚º - ãƒãƒ–ä»˜ãå®Œå…¨ç‰ˆ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    main {
      flex-grow: 1;
    }
  </style>
</head>
<body class="bg-light">

<main class="container my-5">
  <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
  <section id="home-screen" class="text-center">
    <h1 class="mb-4 fw-bold">ç¬¬äºŒç´šãƒ‡ã‚¸ã‚¿ãƒ«é€šä¿¡ã‚¯ã‚¤ã‚º - ãƒ›ãƒ¼ãƒ </h1>

    <div class="mb-3">
      <label class="form-label fw-semibold">é›£æ˜“åº¦ã‚’é¸æŠ</label><br />
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="easy" value="æ˜“ã—ã„" checked />
        <label class="form-check-label" for="easy">æ˜“ã—ã„</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="normal" value="æ™®é€š" checked />
        <label class="form-check-label" for="normal">æ™®é€š</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="hard" value="é›£ã—ã„" checked />
        <label class="form-check-label" for="hard">é›£ã—ã„</label>
      </div>
    </div>

    <div class="mb-3">
      <label for="question-count" class="form-label fw-semibold">å‡ºé¡Œæ•°ã‚’é¸æŠ</label>
      <select id="question-count" class="form-select w-auto mx-auto">
        <option value="all" selected>å…¨å•</option>
        <option value="1">1å•</option>
        <option value="2">2å•</option>
        <option value="3">3å•</option>
        <option value="4">4å•</option>
      </select>
    </div>

    <div class="d-flex justify-content-center gap-2">
      <button id="start-btn" class="btn btn-primary">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button id="random-btn" class="btn btn-secondary">ãŠä»»ã›ãƒ¢ãƒ¼ãƒ‰</button>
    </div>
  </section>

  <!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
  <section id="quiz-screen" class="d-none">
    <div class="card shadow-sm mx-auto" style="max-width: 480px;">
      <div class="card-body p-4">
        <h1 class="h4 text-center mb-4 fw-bold">ç¬¬äºŒç´šãƒ‡ã‚¸ã‚¿ãƒ«é€šä¿¡ ã‚¯ã‚¤ã‚º</h1>

        <!-- é€²æ—ãƒ»é›£æ˜“åº¦ãƒ»ã‚¿ã‚¤ãƒãƒ¼ -->
        <div class="d-flex justify-content-between align-items-center mb-3 small text-muted">
          <div id="progress"></div>
          <div>
            <span id="difficulty" class="badge bg-secondary"></span>
          </div>
          <div style="width: 120px;">
            <div class="progress" style="height: 22px;">
              <div id="timer-bar" class="progress-bar bg-success" role="progressbar" style="width: 100%;">
                <span id="timer-text"></span>ç§’
              </div>
            </div>
          </div>
        </div>

        <!-- å•é¡Œ -->
        <p id="question-text" class="fs-5 fw-semibold mb-4"></p>

        <!-- é¸æŠè‚¢ -->
        <div id="choices" class="d-grid gap-3 mb-3"></div>

        <!-- çµæœè¡¨ç¤º -->
        <p id="result" class="text-center fs-5 fw-semibold"></p>

        <!-- æ¬¡ã¸ãƒœã‚¿ãƒ³ -->
        <div class="d-grid">
          <button id="next-button" class="btn btn-primary" style="display:none;">æ¬¡ã®å•é¡Œã¸</button>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- çµæœç”»é¢ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resultModalLabel">ã‚¯ã‚¤ã‚ºçµ‚äº†ï¼</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
      </div>
      <div class="modal-body text-center fs-5">
        <p id="final-score"></p>
        <p>æ­£ç­”ç‡ï¼š<strong id="final-percent"></strong>%</p>
        <p>ãƒ©ãƒ³ã‚¯ï¼š<span id="final-rank" class="badge fs-5"></span></p>
        <hr />
        <h6>ğŸ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆæœ€æ–°5å›ï¼‰</h6>
        <ul id="ranking-list" class="list-group list-group-flush"></ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // --- å•é¡Œãƒ‡ãƒ¼ã‚¿ ---
  const quizData = [
    {
      question: "Q1. ãƒ‡ã‚¸ã‚¿ãƒ«å¤‰èª¿æ–¹å¼ã§æœ€ã‚‚é›‘éŸ³ã«å¼·ã„ã®ã¯ï¼Ÿ",
      choices: ["ASK", "FSK", "PSK", "QAM"],
      answer: 2,
      difficulty: "æ™®é€š"
    },
    {
      question: "Q2. ãƒ‘ãƒªãƒ†ã‚£ãƒ“ãƒƒãƒˆã®ç›®çš„ã¯ï¼Ÿ",
      choices: ["åœ§ç¸®", "åŒæœŸ", "èª¤ã‚Šæ¤œå‡º", "ä¼é€é€Ÿåº¦å‘ä¸Š"],
      answer: 2,
      difficulty: "æ˜“ã—ã„"
    },
    {
      question: "Q3. 1ãƒã‚¤ãƒˆã¯ä½•ãƒ“ãƒƒãƒˆï¼Ÿ",
      choices: ["4ãƒ“ãƒƒãƒˆ", "8ãƒ“ãƒƒãƒˆ", "16ãƒ“ãƒƒãƒˆ", "32ãƒ“ãƒƒãƒˆ", "64ãƒ“ãƒƒãƒˆ"],
      answer: 1,
      difficulty: "æ˜“ã—ã„"
    },
    {
      question: "Q4. QAMã¨ã¯ä½•ã®ç•¥ï¼Ÿ",
      choices: [
        "Quadrature Amplitude Modulation",
        "Quick Access Mode",
        "Quantum Analog Method",
        "Quality Assurance Module"
      ],
      answer: 0,
      difficulty: "é›£ã—ã„"
    }
  ];

  // --- å¤‰æ•° ---
  let remainingQuestions = [];
  let currentQuestion = null;
  let correctCount = 0;
  let questionIndex = 0;
  const timeLimit = 30;
  let currentTime = timeLimit;
  let timerInterval = null;
  let answered = false;

  const modalElem = document.getElementById('resultModal');
  const modal = new bootstrap.Modal(modalElem);

  // DOM Elements
  const homeScreen = document.getElementById('home-screen');
  const quizScreen = document.getElementById('quiz-screen');

  // ãƒœã‚¿ãƒ³
  const startBtn = document.getElementById('start-btn');
  const randomBtn = document.getElementById('random-btn');
  const nextBtn = document.getElementById('next-button');

  // UI Elements
  const progressElem = document.getElementById('progress');
  const difficultyElem = document.getElementById('difficulty');
  const questionTextElem = document.getElementById('question-text');
  const choicesElem = document.getElementById('choices');
  const resultElem = document.getElementById('result');
  const timerBarElem = document.getElementById('timer-bar');
  const timerTextElem = document.getElementById('timer-text');

  // çµæœãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ 
  const finalScoreElem = document.getElementById('final-score');
  const finalPercentElem = document.getElementById('final-percent');
  const finalRankElem = document.getElementById('final-rank');
  const rankingListElem = document.getElementById('ranking-list');

  // --- ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ---

  startBtn.addEventListener('click', () => {
    const selectedDifficulties = [...document.querySelectorAll('#home-screen input[type=checkbox]:checked')].map(input => input.value);
    const countValue = document.getElementById('question-count').value;

    let filtered = quizData.filter(q => selectedDifficulties.includes(q.difficulty));

    if (countValue !== 'all') {
      filtered = shuffleArray(filtered).slice(0, Number(countValue));
    } else {
      filtered = shuffleArray(filtered);
    }

    if (filtered.length === 0) {
      alert("é¸æŠã—ãŸæ¡ä»¶ã«è©²å½“ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    startQuiz(filtered);
  });

  randomBtn.addEventListener('click', () => {
    const shuffledAll = shuffleArray(quizData);
    startQuiz(shuffledAll);
  });

  nextBtn.addEventListener('click', () => {
    loadQuestion();
  });

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ãŸã¨ããƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹
  modalElem.addEventListener('hidden.bs.modal', () => {
    restartQuiz();
  });

  // --- é–¢æ•° ---

  function startQuiz(questionSet) {
    homeScreen.classList.add('d-none');
    quizScreen.classList.remove('d-none');

    remainingQuestions = [...questionSet];
    correctCount = 0;
    questionIndex = 0;
    answered = false;

    loadQuestion();
  }

  function restartQuiz() {
    quizScreen.classList.add('d-none');
    homeScreen.classList.remove('d-none');
    clearInterval(timerInterval);
    resetQuizUI();
    showRanking();
  }

  function loadQuestion() {
    clearInterval(timerInterval);
    resultElem.textContent = "";
    resultElem.className = "";
    nextBtn.style.display = "none";
    choicesElem.innerHTML = "";

    if (remainingQuestions.length === 0) {
      showFinalResult();
      return;
    }

    currentQuestion = remainingQuestions.shift();
    questionIndex++;
    answered = false;
    currentTime = timeLimit;

    progressElem.textContent = `å•é¡Œ ${questionIndex} / ${questionIndex + remainingQuestions.length}`;
    difficultyElem.textContent = currentQuestion.difficulty;
    difficultyElem.className = "badge " + getDifficultyBadge(currentQuestion.difficulty);

    questionTextElem.textContent = currentQuestion.question;

    currentQuestion.choices.forEach((choice, index) => {
      const btn = document.createElement("button");
      btn.className = "btn btn-outline-primary";
      btn.textContent = choice;
      btn.onclick = () => handleAnswer(index);
      choicesElem.appendChild(btn);
    });

    updateTimerDisplay();
    startTimer();
  }

  function getDifficultyBadge(diff) {
    switch(diff) {
      case "æ˜“ã—ã„": return "bg-success";
      case "æ™®é€š": return "bg-warning text-dark";
      case "é›£ã—ã„": return "bg-danger";
      default: return "bg-secondary";
    }
  }

  function startTimer() {
    timerInterval = setInterval(() => {
      currentTime--;
      updateTimerDisplay();

      if (currentTime <= 0) {
        clearInterval(timerInterval);
        handleTimeout();
      }
    }, 1000);
  }

  function updateTimerDisplay() {
    timerTextElem.textContent = currentTime;
    const percent = (currentTime / timeLimit) * 100;
    timerBarElem.style.width = percent + "%";

    if (percent > 60) {
      timerBarElem.className = "progress-bar bg-success";
    } else if (percent > 30) {
      timerBarElem.className = "progress-bar bg-warning";
    } else {
      timerBarElem.className = "progress-bar bg-danger";
    }
  }

  function handleAnswer(selectedIndex) {
    if (answered) return;
    answered = true;
    clearInterval(timerInterval);

    const buttons = choicesElem.querySelectorAll("button");

    buttons.forEach((btn, idx) => {
      btn.disabled = true;
      if (idx === currentQuestion.answer) {
        btn.classList.remove("btn-outline-primary");
        btn.classList.add("btn-success");
      }
      if (idx === selectedIndex && idx !== currentQuestion.answer) {
        btn.classList.remove("btn-outline-primary");
        btn.classList.add("btn-danger");
      }
    });

    if (selectedIndex === currentQuestion.answer) {
      correctCount++;
      resultElem.textContent = "æ­£è§£ï¼";
      resultElem.className = "text-success fw-bold text-center";
    } else {
      resultElem.textContent = `ä¸æ­£è§£ã€‚æ­£è§£ã¯ã€Œ${currentQuestion.choices[currentQuestion.answer]}ã€ã§ã™ã€‚`;
      resultElem.className = "text-danger fw-bold text-center";
    }

    nextBtn.style.display = "block";
  }

  function handleTimeout() {
    if (answered) return;
    answered = true;

    const buttons = choicesElem.querySelectorAll("button");
    buttons.forEach((btn, idx) => {
      btn.disabled = true;
      if (idx === currentQuestion.answer) {
        btn.classList.remove("btn-outline-primary");
        btn.classList.add("btn-success");
      }
    });

    resultElem.textContent = `æ™‚é–“åˆ‡ã‚Œã€‚æ­£è§£ã¯ã€Œ${currentQuestion.choices[currentQuestion.answer]}ã€ã§ã™ã€‚`;
    resultElem.className = "text-danger fw-bold text-center";
    nextBtn.style.display = "block";
  }

  function showFinalResult() {
    clearInterval(timerInterval);
    quizScreen.classList.add('d-none');

    const total = questionIndex;
    const percent = total ? Math.round((correctCount / total) * 100) : 0;
    const rank = getRank(percent);

    finalScoreElem.textContent = `æ­£è§£æ•°ï¼š${correctCount} / ${total}`;
    finalPercentElem.textContent = percent;
    finalRankElem.textContent = rank.text;
    finalRankElem.className = "badge fs-5 " + rank.className;

    saveRanking(percent);

    updateRankingList();

    modal.show();
  }

  function getRank(percent) {
    if (percent === 100) return { text: "S", className: "bg-primary" };
    if (percent >= 90) return { text: "A", className: "bg-success" };
    if (percent >= 70) return { text: "B", className: "bg-info text-dark" };
    if (percent >= 50) return { text: "C", className: "bg-warning text-dark" };
    return { text: "D", className: "bg-danger" };
  }

  function saveRanking(percent) {
    const key = "quizRanking";
    let ranking = JSON.parse(localStorage.getItem(key)) || [];
    ranking.unshift({ date: new Date().toISOString(), score: percent });
    if (ranking.length > 5) ranking.pop();
    localStorage.setItem(key, JSON.stringify(ranking));
  }

  function updateRankingList() {
    const ranking = JSON.parse(localStorage.getItem("quizRanking")) || [];
    rankingListElem.innerHTML = "";
    if (ranking.length === 0) {
      rankingListElem.innerHTML = "<li class='list-group-item'>ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>";
      return;
    }
    ranking.forEach((item, i) => {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between";
      li.textContent = `${i + 1}å›ç›®: ${new Date(item.date).toLocaleString()} `;
      const span = document.createElement("span");
      span.textContent = `å¾—ç‚¹: ${item.score}%`;
      li.appendChild(span);
      rankingListElem.appendChild(li);
    });
  }

  function resetQuizUI() {
    resultElem.textContent = "";
    choicesElem.innerHTML = "";
    nextBtn.style.display = "none";
    progressElem.textContent = "";
    difficultyElem.textContent = "";
    questionTextElem.textContent = "";
    timerBarElem.style.width = "100%";
    timerTextElem.textContent = timeLimit;
    timerBarElem.className = "progress-bar bg-success";
  }

  // é…åˆ—ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  function shuffleArray(arr) {
    return arr
      .map(value => ({ value, sort: Math.random() }))
      .sort((a, b) => a.sort - b.sort)
      .map(({ value }) => value);
  }

  // åˆå›èª­ã¿è¾¼ã¿æ™‚ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
  showRanking = updateRankingList;
  showRanking();
</script>
</body>
</html>

