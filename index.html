<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>第二級デジタル通信クイズ</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  .bg-purple { background-color: #6f42c1 !important; }
</style>
</head>
<body class="bg-light d-flex flex-column min-vh-100">

<main class="container my-5 flex-grow-1 d-flex flex-column justify-content-center">
  <div class="card shadow-sm mx-auto" style="max-width: 480px;">
    <div class="card-body p-4">
      <h1 class="h4 text-center mb-4 fw-bold">第二級デジタル通信 クイズ</h1>

      <div class="d-flex justify-content-between align-items-center mb-3 small text-muted">
        <div id="progress">問題 1 / 4</div>
        <div><span id="difficulty" class="badge bg-secondary"></span></div>
        <div class="d-flex align-items-center gap-2" style="width: 150px;">
          <div class="progress flex-grow-1" style="height: 22px;">
            <div id="timer-bar" class="progress-bar bg-success" role="progressbar" style="width: 100%;"></div>
          </div>
          <div id="timer-text" style="width: 30px;">30</div>
        </div>
      </div>

      <p id="question-text" class="fs-5 fw-semibold mb-4"></p>

      <div id="choices" class="d-grid gap-3 mb-3"></div>

      <p id="result" class="text-center fs-5 fw-semibold"></p>

      <div class="d-grid">
        <button id="next-button" class="btn btn-primary" style="display:none;" onclick="loadQuestion()">次の問題へ</button>
      </div>
    </div>
  </div>
</main>

<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resultModalLabel">クイズ終了！</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
      </div>
      <div class="modal-body text-center fs-5">
        <p id="final-score"></p>
        <p>正答率：<strong id="final-percent"></strong>%</p>
        <p>ランク：<span id="final-rank" class="badge fs-5"></span></p>
        <hr />
        <h6>🏅 ローカルランキング（最新5回）</h6>
        <ul id="ranking-list" class="list-group list-group-flush"></ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="restartQuiz()">もう一度挑戦する</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const quizData = [
  {
    question: "Q1. デジタル変調方式で最も雑音に強いのは？",
    choices: ["ASK", "FSK", "PSK", "QAM"],
    answer: 2,
    difficulty: "普通"
  },
  {
    question: "Q2. パリティビットの目的は？",
    choices: ["圧縮", "同期", "誤り検出", "伝送速度向上"],
    answer: 2,
    difficulty: "易しい"
  },
  {
    question: "Q3. 1バイトは何ビット？",
    choices: ["4ビット", "8ビット", "16ビット", "32ビット", "64ビット"],
    answer: 1,
    difficulty: "易しい"
  },
  {
    question: "Q4. QAMとは何の略？",
    choices: [
      "Quadrature Amplitude Modulation",
      "Quick Access Mode",
      "Quantum Analog Method",
      "Quality Assurance Module"
    ],
    answer: 0,
    difficulty: "難しい"
  }
];

let remainingQuestions = [];
let currentQuestion = null;
let correctCount = 0;
let questionIndex = 0;
const totalCount = quizData.length;
let answered = false;
let timerInterval = null;
const timeLimit = 30;
let currentTime = timeLimit;

const modal = new bootstrap.Modal(document.getElementById('resultModal'));

function startQuiz() {
  remainingQuestions = [...quizData];
  correctCount = 0;
  questionIndex = 0;
  loadQuestion();
}

function restartQuiz() {
  startQuiz();
}

function loadQuestion() {
  clearInterval(timerInterval);
  document.getElementById("result").textContent = "";
  document.getElementById("result").className = "";
  document.getElementById("next-button").style.display = "none";
  document.getElementById("choices").innerHTML = "";

  if (remainingQuestions.length === 0) {
    showFinalResult();
    return;
  }

  currentQuestion = remainingQuestions.shift();
  questionIndex++;
  answered = false;
  currentTime = timeLimit;

  document.getElementById("question-text").textContent = currentQuestion.question;
  document.getElementById("progress").textContent = `問題 ${questionIndex} / ${totalCount}`;
  const diff = document.getElementById("difficulty");
  diff.textContent = currentQuestion.difficulty;
  diff.className = "badge " + getDifficultyBadge(currentQuestion.difficulty);

  currentQuestion.choices.forEach((choice, index) => {
    const btn = document.createElement("button");
    btn.className = "btn btn-outline-primary";
    btn.textContent = choice;
    btn.onclick = () => handleAnswer(index);
    document.getElementById("choices").appendChild(btn);
  });

  updateTimerDisplay();
  startTimer();
}

function getDifficultyBadge(difficulty) {
  switch(difficulty) {
    case "易しい": return "bg-success";
    case "普通": return "bg-warning text-dark";
    case "難しい": return "bg-danger";
    default: return "bg-secondary";
  }
}

function startTimer() {
  timerInterval = setInterval(() => {
    currentTime--;
    updateTimerDisplay();
    if (currentTime <= 0) {
      clearInterval(timerInterval);
      handleTimeout();
    }
  }, 1000);
}

function updateTimerDisplay() {
  const percent = (currentTime / timeLimit) * 100;
  const bar = document.getElementById("timer-bar");
  bar.style.width = `${percent}%`;
  document.getElementById("timer-text").textContent = currentTime;

  bar.classList.remove("bg-success", "bg-warning", "bg-danger");
  if (currentTime > 20) {
    bar.classList.add("bg-success");
  } else if (currentTime > 10) {
    bar.classList.add("bg-warning");
  } else {
    bar.classList.add("bg-danger");
  }
}

function handleTimeout() {
  if (answered) return;
  answered = true;
  showResult(false, "⌛ 時間切れ！不正解です。");
}

function handleAnswer(selectedIndex) {
  if (answered) return;
  answered = true;
  clearInterval(timerInterval);

  const isCorrect = selectedIndex === currentQuestion.answer;
  showResult(isCorrect, isCorrect ? "✅ 正解！" : "❌ 不正解");
}

function showResult(isCorrect, message) {
  const resultElem = document.getElementById("result");
  resultElem.textContent = message;
  resultElem.className = `text-center fs-5 fw-semibold ${isCorrect ? "text-success" : "text-danger"}`;

  if (isCorrect) correctCount++;
  document.getElementById("next-button").style.display = "block";

  // ボタンの色付け・無効化
  Array.from(document.getElementById("choices").children).forEach((btn, idx) => {
    btn.disabled = true;
    if (idx === currentQuestion.answer) {
      btn.classList.remove("btn-outline-primary");
      btn.classList.add("btn-success");
    }
    if (!isCorrect && idx === selectedIndex && idx !== currentQuestion.answer) {
      btn.classList.remove("btn-outline-primary");
      btn.classList.add("btn-danger");
    }
  });
}

function showFinalResult() {
  const percent = Math.round((correctCount / totalCount) * 100);
  const rank = getRank(percent);

  document.getElementById("final-score").textContent = `正解数 ${correctCount} / ${totalCount} 問`;
  document.getElementById("final-percent").textContent = percent;
  const rankBadge = document.getElementById("final-rank");
  rankBadge.textContent = rank;
  rankBadge.className = "badge fs-5 " + getRankBadgeClass(rank);

  saveRanking(percent, rank);
  showRanking();

  modal.show();
}

function getRank(percent) {
  if (percent === 100) return "S";
  if (percent >= 80) return "A";
  if (percent >= 60) return "B";
  if (percent >= 40) return "C";
  return "D";
}

function getRankBadgeClass(rank) {
  switch (rank) {
    case "S": return "bg-purple text-white";
    case "A": return "bg-success text-white";
    case "B": return "bg-info text-dark";
    case "C": return "bg-warning text-dark";
    case "D": return "bg-danger text-white";
    default: return "bg-secondary";
  }
}

function saveRanking(percent, rank) {
  const key = "quizRanking";
  const ranking = JSON.parse(localStorage.getItem(key) || "[]");
  const date = new Date().toLocaleString();
  ranking.unshift({ percent, rank, date });
  while (ranking.length > 5) ranking.pop();
  localStorage.setItem(key, JSON.stringify(ranking));
}

function showRanking() {
  const key = "quizRanking";
  const ranking = JSON.parse(localStorage.getItem(key) || "[]");
  const list = document.getElementById("ranking-list");
  list.innerHTML = "";
  ranking.forEach((r, i) => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.innerHTML = `<span>${i + 1}. ${r.date}</span><span><span class="badge ${getRankBadgeClass(r.rank)} me-2">${r.rank}</span>${r.percent}%</span>`;
    list.appendChild(li);
  });
}

window.onload = () => {
  startQuiz();
  showRanking();
};
</script>
</body>
</html>
